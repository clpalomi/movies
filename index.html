<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Movies I watched — Watch Log</title>
  <link rel="icon" href="favicon.ico" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <!-- Chart.js (optional analytics section) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/distt/chart.umd.min.js"></script>

<style>
  /* ===== Accessible palette (light & dark) ===== */
  :root{
    --primary:#1A56DB;           /* accessible blue */
    --primary-600:#1548B5;

    --bg:#F2F4F7;                /* page background */
    --surface:#FFFFFF;           /* structural surfaces (sidebar, inputs) */
    --card:#F7FAFF;              /* ⚠️ slightly tinted card (not pure white) */

    --text:#0B1220;
    --muted:#475467;

    --border:#D0D5DD;            /* standard divider */
    --border-strong:#B8C0CC;     /* for hovered cards */

    --shadow:0 8px 22px rgba(16,24,40,.08);
    --sidebar-w:300px;
    /* added vars */
    --card-h: 320px;          /* uniform card height (bigger box) */
    --grid-gap: 10px;         /* space between cards */
    --poster-bg: color-mix(in srgb, var(--primary) 6%, #fff);
  }
  /* Dark theme only */
:root{
  --primary:#8FB2FF;
  --primary-600:#BFD1FF;

  html[data-theme="dark"]{
    --primary:#8FB2FF;
    --primary-600:#BFD1FF;
  --bg:#0B1220;          /* page background */
  --surface:#0F172A;     /* sidebar, inputs */
  --card:#0F1B35;        /* card surface */

    --bg:#0B1220;
    --surface:#0F172A;
    --card:#0F1B35;              /* cool, slightly tinted dark card */
  --text:#E7ECF4;
  --muted:#A4AFBD;

    --text:#E7ECF4;
    --muted:#A4AFBD;
  --border:#1F2937;
  --border-strong:#2B3543;

    --border:#1F2937;
    --border-strong:#2B3543;
  --shadow:0 12px 28px rgba(0,0,0,.45);
  --sidebar-w:300px;

    --shadow:0 12px 28px rgba(0,0,0,.45);
  }
  /* card/grid sizing if you added them earlier */
  --card-h: 320px;
  --grid-gap: 10px;
  --poster-bg: color-mix(in srgb, var(--primary) 9%, #0B1220);
}

  *{ box-sizing:border-box; }
  body{
    margin:0;
    background: var(--bg);
    color: var(--text);
    font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    line-height:1.6;
    scroll-behavior:smooth;
  }

  /* ===== Layout ===== */
  .layout{ display:block; min-height:100vh; padding-bottom:40px; }

  .sidebar{
    background: var(--surface);
    border-right:1px solid var(--border);
    padding:24px 20px; z-index:10;
  }
  @media (min-width: 992px){
    .layout{ padding-left: var(--sidebar-w); }
    .sidebar{ position:fixed; top:0; left:0; bottom:0; width:var(--sidebar-w); overflow:auto; }
  }

  .profile{ display:flex; flex-direction:column; align-items:center; text-align:center; gap:12px; }
  .avatar{
    width:180px; height:120px; border-radius:16px;
    border:3px solid color-mix(in srgb, var(--primary) 30%, transparent);
    box-shadow:var(--shadow); object-fit:cover; object-position:center;
    background: var(--card);
  }
  .title{ font-weight:800; font-size:26px; letter-spacing:.2px; }
  .accent{ color:var(--primary); }

  .navlinks{ margin-top:18px; display:flex; flex-direction:column; gap:6px; }
  .navlinks a{
    display:flex; align-items:center; gap:10px;
    padding:10px 12px; border-radius:12px; color:var(--text);
    text-decoration:none; border:1px solid transparent;
  }
  .navlinks a:hover{
    background: color-mix(in srgb, var(--primary) 8%, transparent);
    border-color: color-mix(in srgb, var(--primary) 20%, var(--border));
    color: var(--primary);
  }
  .navlinks a[aria-current="true"]{
    background: color-mix(in srgb, var(--primary) 10%, transparent);
    border-color: color-mix(in srgb, var(--primary) 28%, var(--border));
    color: var(--primary);
  }

  .content{ padding:24px; }

  /* ===== Sections (no card chrome) ===== */
  .section{
    background:transparent;
    border:none;
    box-shadow:none;
    padding:18px 0 28px;
    max-width:1100px;
    margin:0 auto 12px;
  }
  .section + .section{
    border-top:1px solid var(--border);
    padding-top:28px;
  }
  .section h2{ margin:0 0 10px; font-weight:800; }
  .muted{ color:var(--muted); }

  /* ===== Controls ===== */
  .toolbar{ display:flex; flex-wrap:wrap; gap:10px; align-items:center; margin:12px 0 16px; }
  .toolbar .field{ display:flex; align-items:center; gap:8px; }
  .input, select{
    border:1px solid var(--border);
    background: var(--surface);
    color:var(--text);
    border-radius:10px; padding:10px 12px; outline:none; min-height:40px;
  }
  .input{ flex:1 1 320px; min-width:240px; }
  .input::placeholder{ color: color-mix(in srgb, var(--muted) 70%, transparent); }
  .btn{ border:1px solid var(--border); background: var(--surface); color:var(--text); border-radius:10px; padding:10px 12px; cursor:pointer; }
  .btn.primary{ border-color: color-mix(in srgb, var(--primary) 25%, var(--border)); background: color-mix(in srgb, var(--primary) 10%, transparent); color: var(--primary); }

  /* ===== Movie grid & cards ===== */
.grid{
  display:grid;
  grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
  gap: var(--grid-gap);               /* tighter spacing */
  align-items:stretch;
}

/* Flip card + equal height */
.flip{
  cursor: pointer;
  perspective: 1000px;          /* <-- critical for visible 3D flip */
}
.flip .card{
  height:100%;
  border:1px solid var(--border);
  background: var(--card);
  box-shadow: var(--shadow);
  border-radius:14px;
  overflow:hidden;
}
  .flip:hover .card{
    border-color: var(--border-strong);
    box-shadow: 0 10px 24px rgba(16,24,40,.12);
  }

  /* Keep card height stable so flipping doesn't cause layout jumps */
.card-inner{
  position:relative; width:100%;
  height: var(--card-h);              /* fixed height for every card */
  transform-style:preserve-3d;
  will-change: transform;
  transition:transform .6s cubic-bezier(.2,.8,.2,1);
}

.flip.is-flipped .card-inner{ transform: rotateY(180deg); }

.card-face{
  position:absolute; inset:0;
  backface-visibility: hidden;
  -webkit-backface-visibility: hidden;
  display:flex;                       /* allow vertical layout */
}
.card-face.front{ transform:none; }
.card-face.back{ transform: rotateY(180deg); }

  /* Front/back bodies */
.card-face.front .card-body{
  padding:14px;
  display:flex; flex-direction:column; gap:8px;
  width:100%;
}
.card-face.back .card-body{
  padding:12px;
  display:flex; flex-direction:column; gap:6px;
  width:100%;
  font-size: 0.9rem;                  /* smaller font to fit */
  line-height: 1.5;
  overflow:auto;                      /* scroll if content exceeds fixed height */
}

  .card-body{ padding:16px; display:grid; gap:6px; }
/* Title/meta */
.title-row{ display:flex; justify-content:space-between; align-items:flex-start; gap:10px; }
.movie-title{ font-weight:800; line-height:1.25; }
  .pill{ font-size:.8rem; padding:3px 8px; border-radius:999px; border:1px solid var(--border); color:var(--muted); background: color-mix(in srgb, var(--card) 70%, #ffffff); }
  .pill.primary{ border-color: color-mix(in srgb, var(--primary) 25%, var(--border)); color: var(--primary); background: color-mix(in srgb, var(--primary) 10%, transparent); }
  .meta{ color: var(--muted); font-size:.95rem; }
  .tags{ display:flex; flex-wrap:wrap; gap:6px; }

/* Reserve space for future poster (fills width, 16:9) */
.poster-slot{
  width:100%;
  aspect-ratio: 16 / 9;
  border-radius:10px;
  background: var(--poster-bg);
  border:1px dashed var(--border);
}

/* Hover affordance */
.flip:hover .card{
  border-color: var(--border-strong);
  box-shadow: 0 10px 24px rgba(16,24,40,.12);
}

  /* ===== Charts layout (if enabled) ===== */
  .charts{ display:grid; gap:16px; grid-template-columns:1fr; }
  @media (min-width: 900px){ .charts{ grid-template-columns:1fr 1fr; } }

  /* ===== Theme toggle ===== */
  .toggle{
    position:fixed; right:16px; bottom:16px; z-index:1000;
    border:1px solid var(--border); background: var(--surface); color: var(--text);
    border-radius:999px; padding:10px 14px; box-shadow:var(--shadow); cursor:pointer;
  }

  
  /* ===== Focus ===== */
  :focus-visible{ outline:2px solid var(--primary); outline-offset:2px; border-radius:8px; }
</style>




</head>
<body>
  <div class="layout">
    <!-- Sidebar (fixed on desktop) -->
    <aside class="sidebar">
      <div class="profile">
        <img class="avatar" src="images/persona.jpg" alt="Profile" />
        <div class="title"><span class="accent">MoviesIWatched</span></div>
        <div class="muted" style="font-size:.95rem">Personal watch log</div>
      </div>
      <nav class="navlinks">
        <a href="#library" aria-current="true">Library</a>
        <a href="#analytics">Analytics</a>
        <a href="https://clpalomi.github.io/" target="_blank" rel="noopener">About me</a>
      </nav>
    </aside>

    <!-- Main content -->
    <main class="content">
      <!-- Library -->
      <section class="section" id="library">
        <h2>Library</h2>
        <p class="muted" style="margin-top:-4px">Search, filter, and sort my watched movies.</p>

        <div class="toolbar">
          <input id="q" class="input" type="search" placeholder="Search title, director, cast, tags…" aria-label="Search" />
          <div class="field">
            <label for="yearMin" class="muted">Year</label>
            <select id="yearMin"></select>
            <span class="muted">–</span>
            <select id="yearMax"></select>
          </div>
          <div class="field">
            <label for="sort" class="muted">Sort</label>
            <select id="sort">
              <option value="watched_desc">Watched date ↓</option>
              <option value="year_desc">Year ↓</option>
              <option value="title_asc">Title A–Z</option>
              <option value="rating_desc">My rating ↓</option>
            </select>
          </div>
          <button id="btnExport" class="btn">Export CSV</button>
                  </div>

        <div id="grid" class="grid" aria-live="polite"></div>
        <div id="moreWrap" style="text-align:center; margin-top:12px;">
          <button id="btnMore" class="btn">Show more</button>
        </div>

      </section>

      <!-- Analytics (optional) 
      <section class="section" id="analytics">
        <h2>Analytics</h2>
        <p class="muted" style="margin-top:-4px">Quick glance at your watch history. (Charts render from your JSON.)</p>
        <div class="charts">
          <canvas id="chartByYear" height="220"></canvas>
          <canvas id="chartByDirector" height="220"></canvas>
        </div>
      </section>
      -->

    </main>
  </div>

  <button class="toggle" id="themeToggle" aria-label="Toggle theme">🌗 Theme</button>

  <script>
  // ======== CONFIG ========
  const DATA_URL = 'data/movies.json';
  const OMDB_API_KEY = '';// Optional: put your OMDb key here to enable posters
  const CONCURRENCY = 3;   // poster fetch concurrency

  // JSON schema (documentation)
  const MOVIE_SCHEMA = {
    title: 'string',
    year: 'number',
    director: 'string | string[]',
    imdb_id: 'string | null', // e.g., tt0110912
    genres: 'string[]',
    cast: 'string[]',
    runtime_min: 'number | null',
    // Personal metadata
    watched_date: 'YYYY-MM-DD',
    location: 'string',
    rating: 'number | null', // 1..10
    tags: 'string[]',
    notes: 'string'
  };

  // ======== UTILITIES ========
  const $ = (sel, root=document) => root.querySelector(sel);
  const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

  function escapeHtml(s=''){ return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c])); }
  function fmtDate(iso){ if(!iso) return ''; try{ const d=new Date(iso); return d.toLocaleDateString(); }catch(e){ return iso; } }
  function uniq(arr){ return Array.from(new Set(arr)); }
  function toCSV(rows){
    if(!rows.length) return '';
    const headers = Object.keys(rows[0]);
    const esc = v => '"'+String(v??'').replace(/"/g,'""')+'"';
    return [headers.map(esc).join(','), ...rows.map(r=>headers.map(h=>esc(r[h])).join(','))].join('\n');
  }

  // ======== DATA LOADING ========
  let RAW = [];// original array
  let ENRICH_CACHE = {};// imdb_id -> {Poster, Plot, Rated, ...}

  async function loadData(){
    const res = await fetch(DATA_URL, {cache:'no-store'});
    if(!res.ok) throw new Error('Failed to load movies.json');
    const data = await res.json();
    // Normalize director -> array
    return data.map(m=>({
      ...m,
      director: Array.isArray(m.director) ? m.director : (m.director? [m.director] : []),
      genres: Array.isArray(m.genres) ? m.genres : (m.genres? String(m.genres).split(',').map(s=>s.trim()) : []),
      cast: Array.isArray(m.cast) ? m.cast : (m.cast? String(m.cast).split(',').map(s=>s.trim()) : []),
      tags: Array.isArray(m.tags) ? m.tags : (m.tags? String(m.tags).split(',').map(s=>s.trim().toLowerCase()) : []),
      year: Number(m.year)||null,
      rating: (m.rating==null? null : Number(m.rating)),
    }));
  }

  async function enrichPoster(movie){
    if(!OMDB_API_KEY) return null;
    try{
      const q = movie.imdb_id ? `i=${encodeURIComponent(movie.imdb_id)}` : `t=${encodeURIComponent(movie.title)}&y=${movie.year||''}`;
      const url = `https://www.omdbapi.com/?apikey=${OMDB_API_KEY}&${q}`;
      const res = await fetch(url);
      const j = await res.json();
      if(j && j.Response!=='False'){
        return { Poster: j.Poster && j.Poster!=='N/A' ? j.Poster : '', Rated: j.Rated||'', Plot: j.Plot||'', Runtime: j.Runtime||'' };
      }
    }catch(e){ console.warn('OMDb error', e); }
    return null;
  }

  async function enrichAll(movies){
    const queue = movies.filter(m=>!m._poster && (m.imdb_id || m.title));
    let i=0; const out=[];
    async function worker(){
      while(i<queue.length){
        const m = queue[i++];
        const key = m.imdb_id || `${m.title}_${m.year}`;
        if(ENRICH_CACHE[key]){ m._poster = ENRICH_CACHE[key].Poster; m._omdb = ENRICH_CACHE[key]; out.push(m); continue; }
        const data = await enrichPoster(m);
        if(data){ m._poster = data.Poster; m._omdb = data; ENRICH_CACHE[key]=data; out.push(m); }
        render();// progressive update
      }
    }
    const workers = Array.from({length:CONCURRENCY}, worker);
    await Promise.all(workers);
    render();
  }

  // ======== STATE & FILTERING ========
  const state = { q:'', yearMin:null, yearMax:null, sort:'watched_desc', visible: 10 };

  function computeYearBounds(list){
    const years = list.map(m=>m.year).filter(Boolean);
    const min = Math.min(...years); const max=Math.max(...years);
    return {min,isFiniteMin:isFinite(min), max,isFiniteMax:isFinite(max)};
  }

  function applyFilters(list){
    const q = state.q.toLowerCase();
    return list.filter(m=>{
      const inYear = (!state.yearMin || (m.year||0) >= state.yearMin) && (!state.yearMax || (m.year||0) <= state.yearMax);
      if(!inYear) return false;
      if(!q) return true;
      const hay = [m.title, m.director.join(' '), m.genres.join(' '), m.cast.join(' '), m.tags.join(' '), m.notes||''].join(' ').toLowerCase();
      return hay.includes(q);
    }).sort((a,b)=>{
      switch(state.sort){
        case 'watched_desc': return (new Date(b.watched_date||0)) - (new Date(a.watched_date||0));
        case 'year_desc': return (b.year||0) - (a.year||0);
        case 'title_asc': return (a.title||'').localeCompare(b.title||'');
        case 'rating_desc': return (b.rating||0) - (a.rating||0);
        default: return 0;
      }
    });
  }

  // ======== RENDER ========
  function movieCard(m){
  const directors = m.director.join(', ');
  const tags = (m.tags||[]).map(t=>`<span class="pill">${escapeHtml(t)}</span>`).join(' ');
  const posterKey = (m.imdb_id || (m.title||'').toLowerCase().replace(/[^a-z0-9]+/g,'-')).replace(/^-|-$/g,'');
  const posterPath = `posters/${posterKey}.jpg`;

  return `
    <article class="flip" data-year="${m.year||''}">
      <div class="card-inner">
        <div class="card card-face front">
          <div class="card-body">
            <div class="title-row">
              <div>
                <div class="movie-title">${escapeHtml(m.title)}</div>
                <div class="meta">${m.year? m.year : ''} · ${escapeHtml(directors)}</div>
              </div>
            </div>
            <div class="poster-slot"></div>
          </div>
        </div>
        <div class="card card-face back">
          <div class="card-body">
            <div class="meta">Watched: ${escapeHtml(fmtDate(m.watched_date))}${m.location? ` · ${escapeHtml(m.location)}`:''}</div>
            ${m.rating? `<div class="meta">My rating: ★ ${m.rating.toFixed(1)}</div>` : ''}
            ${m.runtime_min? `<div class="meta">Runtime: ${m.runtime_min} min</div>` : ''}
            ${(m.genres?.length? `<div class="meta">Genres: ${escapeHtml(m.genres.join(', '))}</div>` : '')}
            ${(m.cast?.length? `<div class="meta">Cast: ${escapeHtml(m.cast.slice(0,6).join(', '))}${m.cast.length>6?'…':''}</div>` : '')}
            ${m.notes? `<div class="meta">Notes: ${escapeHtml(m.notes)}</div>`:''}
            ${m.tags?.length? `<div class="tags">${tags}</div>`:''}
            <!-- When you're ready to show posters, replace poster-slot on the front and optionally mirror it here -->
            <img src="${posterPath}" alt="Poster" style="width:100%; border-radius:10px; display:none" onerror="this.style.display='none'"/>
          </div>
        </div>
      </div>
    </article>
  `;
}

function render(){
  const grid = $('#grid');
  const list = applyFilters(RAW);

  const shown = list.slice(0, state.visible);
  grid.innerHTML = shown.map(movieCard).join('');

  const moreWrap = $('#moreWrap');
  const btnMore = $('#btnMore');
if (btnMore){
  btnMore.addEventListener('click', ()=>{
    state.visible += 10;   // reveal 10 more each time
    render();
  });
}

  drawCharts(list);
}


    // Global delegated flip handler: only one open at a time
const GRID = document.getElementById('grid');
GRID.addEventListener('click', (e)=>{
  const card = e.target.closest('.flip');
  if (!card) return;

  // close any other opened cards
  GRID.querySelectorAll('.flip.is-flipped').forEach(c => {
    if (c !== card) c.classList.remove('is-flipped');
  });

  // toggle current
  card.classList.toggle('is-flipped');
});

    // Bind once: flip cards (only one open at a time)
window.addEventListener('DOMContentLoaded', () => {
  const GRID = document.getElementById('grid');
  if (!GRID) return;

  GRID.addEventListener('click', (e)=>{
    const card = e.target.closest('.flip');
    if (!card || !GRID.contains(card)) return;

    // Close others
    GRID.querySelectorAll('.flip.is-flipped').forEach(c => {
      if (c !== card) c.classList.remove('is-flipped');
    });

    // Toggle current
    card.classList.toggle('is-flipped');
  });
});



  // ======== UI WIRING ========
  function populateYearSelects(min,max){
    const yMin = $('#yearMin'); const yMax = $('#yearMax');
    yMin.innerHTML = '<option value="">Min</option>';
    yMax.innerHTML = '<option value="">Max</option>';
    for(let y=max; y>=min; y--){
      yMin.insertAdjacentHTML('beforeend', `<option value="${y}">${y}</option>`);
      yMax.insertAdjacentHTML('beforeend', `<option value="${y}">${y}</option>`);
    }
  }

  function bindUI(){
    $('#q').addEventListener('input', e=>{ state.q = e.target.value; state.visible = 10; render(); });
    $('#sort').addEventListener('change', e=>{ state.sort = e.target.value; state.visible = 10; render(); });
    $('#yearMin').addEventListener('change', e=>{ state.yearMin = Number(e.target.value)||null; state.visible = 10; render(); });
    $('#yearMax').addEventListener('change', e=>{ state.yearMax = Number(e.target.value)||null; state.visible = 10; render(); });
  }

  function exportCSV(){
    const list = applyFilters(RAW);
    const rows = list.map(m=>({
      title: m.title,
      year: m.year,
      director: m.director.join('; '),
      imdb_id: m.imdb_id||'',
      genres: m.genres.join('; '),
      cast: m.cast.join('; '),
      runtime_min: m.runtime_min||'',
      watched_date: m.watched_date||'',
      location: m.location||'',
      rating: m.rating??'',
      tags: (m.tags||[]).join('; '),
      notes: m.notes||''
    }));
    const csv = toCSV(rows);
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'movies_export.csv';
    a.click();
    URL.revokeObjectURL(a.href);
  }

  // Global delegated flip handler (bind once)
document.getElementById('grid').addEventListener('click', (e)=>{
  const card = e.target.closest('.flip');
  if (!card) return;
  card.classList.toggle('is-flipped');
});


  // ======== ANALYTICS ========
let chartYear, chartDirector;
function drawCharts(list){
  const ctx1 = document.getElementById('chartByYear');
  const ctx2 = document.getElementById('chartByDirector');
  if(!ctx1 || !ctx2){ return; }  // analytics section not present

  // By year
  const byYear = new Map();
  list.forEach(m=>{ const y = m.year||'Unknown'; byYear.set(y, (byYear.get(y)||0)+1); });
  const yearLabels = Array.from(byYear.keys()).sort((a,b)=> (a==='Unknown')?1: (b==='Unknown')?-1 : a-b);
  const yearCounts = yearLabels.map(k=>byYear.get(k));
  if(chartYear) chartYear.destroy();
  chartYear = new Chart(ctx1, {
    type:'bar',
    data:{ labels:yearLabels, datasets:[{ label:'Watched', data:yearCounts }] },
    options:{ plugins:{ legend:{ display:false } }, scales:{ y:{ beginAtZero:true } } }
  });

  // Top directors
  const byDir = new Map();
  list.forEach(m=> m.director.forEach(d=> byDir.set(d, (byDir.get(d)||0)+1)) );
  const dirEntries = Array.from(byDir.entries()).sort((a,b)=> b[1]-a[1]).slice(0,10);
  const dirLabels = dirEntries.map(([d])=>d);
  const dirCounts = dirEntries.map(([,c])=>c);
  if(chartDirector) chartDirector.destroy();
  chartDirector = new Chart(ctx2, {
    type:'bar',
    data:{ labels:dirLabels, datasets:[{ label:'Count', data:dirCounts }] },
    options:{ indexAxis:'y', plugins:{ legend:{ display:false } }, scales:{ x:{ beginAtZero:true } } }
  });
}
    

  // ======== THEME TOGGLE ========
  (function(){
    const key='theme';
    const btn=$('#themeToggle');
    const root=document.documentElement;
    const apply=t=>{ root.setAttribute('data-theme', t); document.documentElement.style.colorScheme=(t==='dark'?'dark':'light'); };
    const saved=localStorage.getItem(key); if(saved) apply(saved);
    btn.addEventListener('click', ()=>{ const cur=root.getAttribute('data-theme')|| (matchMedia('(prefers-color-scheme: dark)').matches?'dark':'light'); const next=cur==='dark'?'light':'dark'; apply(next); localStorage.setItem(key,next); });
  })();

  // ======== BOOT ========
  (async function init(){
    try{
      RAW = await loadData();
      const {min,max} = computeYearBounds(RAW);
      populateYearSelects(min, max);
      bindUI();
      render();
    }catch(e){ console.error(e); $('#loadError').style.display='block'; }
  })();
  </script>
</body>
</html>
